# 作业五

## 1. cache

| 序列 | 地址                                         | 命中率 |
| ---- | -------------------------------------------- | ------ |
| 1    | 0, 2, 4, 8, 16, 32                           | 0.33   |
| 2    | 0, 512, 1024, 1536, 2048, 1536, 1024, 512, 0 | 0.33   |
| 3    | 0, 64, 128, 256, 512, 256, 128, 64, 0        | 0.33   |
| 4    | 0, 512, 1024, 0, 1536, 0, 2048, 512          | 0.25   |

上面给出了运行在带数据 cache 的处理器上的程序所生成的四种不同的地址序列，同时给出了每种序 列的 cache 命中率。假设 cache 在每个序列开始时是空的，请回答该处理器数据 cache 的下述参数分别是多少：

- 相联度(1, 2 还是 4 路) 

  4路。根据序列3，无论何种情况它们都应映射到统一组中，只有组中有4路时才会达到0.33的命中率。

- 块大小(1, 2, 4, 8, 16 还是 32 字节)

  8字节。根据序列1，只有块大小是8字节时能够达成0.33的命中率。

- cache 总容量(256 还是 512 字节) 

  都可以。

- 替换策略(LRU 还是 FIFO) 

  LRU，根据序列4，使用FIFO时命中率大于0.25。

## 2. 内存的交叉存取

### 2.1 

一台机器有 4 KB 的主存，由 1 个通道、1 个 rank 和 N(N>1)个 bank 构成。系统没有虚拟存储。 

- 数据采用 cache 块交叉存取策略进行交叉存取，即连续的 cache 块对应到连续的 bank 上；
- cache 块大小为 32 字节，bank 的 1 行有 128 字节；
- 采用打开行策略，即行缓冲中的行在被访问后继续保持在行缓冲中，直到有别的行被访问； 
- 行缓冲命中指访问的行存在于行缓冲中，行缓冲缺失指访问的行不在行缓冲中。

1. 某个程序在这台机器上执行，访问以下字节时(数字表示字节的位置，比如 320 表示第 320 个字节) 发生片上 cache 缺失而需要访存：0, 32, 320, 480, 4, 36, 324, 484, 8, 40, 328, 488, 12, 44, 332, 492，若行缓冲命中率为 0，即所有访问的行都不在行缓冲中，请问 bank 数 N 的最小值是多少? 

   对于cache的访问，其访问的cache块编号顺序为：0、1、10、15、0、1、10、15、0、1、10、15、0、1、10、15；

   N=1时，cache块只能映射到同一bank上，bank1行128字节可以存放4个cache块，0、1映射到同一行，访存时会发生行缓冲命中；

   N=2时，0、1号cache块分布在两个不同的bank上，0、10、15在不同行，符合题意。

   因此最小N=2。

2. 如果对于同一个序列，行缓冲命中率是 75%，请问 bank 数 N 的最小值是多少? 

   想要命中率达到75%，必须要0、1、10、15块在首次访问后，后续访问都在行缓冲内。

   从N=1向上推理，可知N=4时，0号cache在bank0、1号cache在bank1、10号cache在bank2、15号cache在bank3，可以符合要求。

   所以最小N=4。

3. 对于同一序列，行缓冲的命中率能达到 100%吗? 请解释原因；如果能达到, 最少需要多少 bank 才能够获得100%的行缓冲命中率? 

   行缓冲命中率不能达到100%，因为首次访问时无论如何行缓冲一定是缺失的；

   如果不考虑初次访问时的行缓冲缺失，那么第2问中4个bank就可以达到100%命中率。

### 2.2 

一个 DRAM 主存储系统由 1 个通道、1 个 rank 和 N 个 bank 构成。Bank 一行 256 字节，一个 cache 块 64 字节。数据采用跨 bank 的行交叉存取方式组织，物理地址的分配方案如下：

|  行  | Bank |  列  | Bytes in Block |
| :--: | :--: | :--: | :------------: |

采用打开行策略，即行缓冲中的行在被访问后继续保持在行缓冲中，直到有别的行被访问。初始时，所有 bank 的第1024行打开。

1.  当有如下的 cache 块访问序列时，如果系统的行缓冲命中率为 33.3% (即 1/3)，请问系统中共有多 少个 bank: 0, 4, 8, 16, 32, 64, 128, 256, 128, 64, 32, 16, 8, 4, 0

   N=128时，第二次访问64、32、16、8、4时会命中，命中率为1/3。

2. 如果行缓冲命中率是 7/15，请问系统中共有多少个 bank? 

   N=512时，第二次访问128, 64, 32, 16, 8, 4, 0时会命中，命中率7/15。

## 3 Bank

一个处理器的分层存储结构由一个小的 SRAM L1-cache 和一个大的 DRAM 主存储器组成，SRAM 和 DRAM 都被划分成 bank。处理器有 24 位物理地址空间，并且不支持虚拟存储(即所有地址都是物理地 址)。某个应用开始在这个处理器上运行，下图显示了在时间尺度上应用对存储系统引用的过程(包括 在 L1-cache 和主存中)。 例如, 应用对存储第一次引用的字节地址是 0xffbc67(假设所有的引用都是对按字节编址的内存地址的 按字节读取)，但是这次引用在 L1-cache 中不命中 (假设 L1-cache 初始时为空)。紧接着，应用访问主 存，这会经历一次行缓冲的不命中(初始时，假设主存的所有 bank 都打开一个永远不会被任何应用访 问的行)。最后，包含字节地址 0xffbc67 的 cache 块从主存取到 cache 中。 随后的内存引用可能会经历 L1-cache 和/或主存的 bank 冲突(当某个特定的 bank 还在提供之前的某个 引用时)。

1.  L1-cache 的块大小是多少字节? 24-bit 物理地址中哪些位是 cache 块偏移量? (物理地址的最低位为 0 位) 

   根据访问cache时#ffbc67地址缺失、#ffbdd7地址缺失、#ffbc6f地址命中，可知cache的块大小是16字节；

   地址中的低4位（3-0）是块内偏移量。

2.  L1-cache 有多少 bank? 24-bit 物理地址中哪些位是 L1-cache 的 bank 索引? (物理地址的最低位为 0 位) 

   根据发生bank冲突的情况，L1-cache中有4个bank，对应第5-4bit。

3. 主存中有多少 bank? 24-bit 物理地址中哪些位是主存的 bank 索引? (物理地址的最低位为 0 位)

   根据发生bank冲突的情况，主存中有8个bank，对应12-10bit。

4. 物理地址向主存映射时用了什么样的交叉存取方案?

   低位交叉存取。

5. 为了支持 24-bit 的物理地址空间，主存的每一个 bank 需要多少行? 24-bit 物理地址中哪些位是主存 的行索引? (物理地址的最低位为 0 位) 

   23-13bit是行索引，各个bank有2048行。

6. 在一行中的每个 cache 块被称为列，一行中有多少列? 24-bit 物理地址中哪些位是主存的列索引? (物理地址的最低位为 0 位) 

   一行有1024字节，一块cache是16字节，因而一行中有64列。对应9-4bit。

## 4. 内存调度

为了响应访存请求，内存控制器会发射 1 条或多条 DRAM 命令以从 bank 访问数据。有 4 种不同的 DRAM 命令。 1) 激活(ACTIVATE): 取被访问的行装入 bank 的行缓冲。 这一操作也被称为打开行(延迟: 15ns) 2) 预充电(PRECHARGE): 将 bank 的行缓冲中的内容存回行。这一操作也被称为关闭行 (延迟: 15ns) 3) 读/写: 从行缓冲中访问数据(延迟: 15ns) 下图显示了在时刻 t0 时内存控制器中的内存请求缓冲的快照。每一个请求按照颜色的不同代表了其所 属的不同应用(假设所有的应用运行在独立的核上)。同时，每个请求标注了它要访问的行地址(或索引)， 例如 R3 表示请求的是第 3 行。另外，假设所有的请求都是读请求。

访存请求在读命令完成后被响应(即读命令被发射 15ns 之后)，每个应用(A、B 或 C)停顿直到它所有访 存请求被响应为止。 假设初始时(t0 时)，每个 bank 的第 3 行和第 12 行分别被取出并存入行缓冲，没有任何其他应用的请 求到达内存控制器。

### 4.1 非应用感知的调度策略

1. 使用先来先服务调度策略(FCFS)，每个应用的停顿时间是多少？

   - 应用A：
     - Bank0中2命中7缺失，用时2 * 15 + 7 * 45 = 30 + 315 = 345ns
     - Bank1中1命中9缺失，用时1 * 15 + 9 * 45 = 15 + 405 = 420ns
     - 等待420ns
   - 应用B：
     - Bank0中2命中8缺失，用时390ns
     - Bank1中1命中8缺失，用时385ns
     - 等待390ns
   - 应用C：
     - Bank0中2命中9缺失，用时435ns
     - Bank1中1命中10缺失，用时465ns
     - 等待465ns

2. 使用行缓冲优先加先来先服务的调度策略(FR-FCFS)，每个应用的停顿时间是多少? 

   - 应用A：
     - Bank0中5命中2缺失，用时5 * 15 + 2 * 45 = 165ns
     - Bank1中4命中6缺失，用时4 * 15 + 6 * 45 = 330ns
     - 等待330ns
   - 应用B：
     - Bank0中5命中5缺失，用时300ns
     - Bank1中4命中2缺失，用时150ns
     - 等待300ns
   - 应用C：
     - Bank0中5命中6缺失，用时345ns
     - Bank1中4命中7缺失，用时375ns
     - 等待375ns

3. FR-FCFS 利用的是内存引用行为的什么特征? 

   空间局部性。

4. 请简要描述可以最大化请求吞吐量的调度策略，请求吞吐量的意思是每单位时间响应的请求数。

   行缓冲优先、请求数少优先、先到先服务。

### 4.2 应用感知的调度策略

图中的 3 个应用，应用 C 是内存密集程度最低的(即有最少的请求数)。然而，它经历了最长的停顿时 间，因为它的请求响应晚于其它多个被优先服务的应用的请求。为了保证应用 C 的停顿时间最短，可以为它的请求分配最高优先级，而给应用 A 和 B 的请求分配同样的低优先级。

1. 调度策略 X: 当应用 C 分配高优先级并且应用 A 和 B 分配相同的低优先级，每个应用的停顿时间是多少? (对于相同优先级的请求，假设使用 FR-FCFS 策略) 

   应用C：45ns

   应用A：330 + 45 + （45 - 15） = 405ns

   应用B：300 + 45 + （45 - 15）= 375ns

2. 为其它两个应用分配优先级，这样你可以最小化所有应用的平均停顿时间。请具体从大到小列出三个应用的优先级(对于相同优先级的请求，假设使用 FR-FCFS 策略) 

   C > B > A

3. 调度策略 Y: 使用你的新调度策略，每个应用的停顿时间分别是多少? (对于相同优先级的请求，假设 使用 FR-FCFS 策略) 

   应用C：45ns

   应用B：240ns

   应用A：405ns

4. 请将四种调度策略 (FCFS, FR-FCFS, X, Y)的平均停顿时间从大到小排列

   FCFS > FR-FCFS > X > Y

## 5. 分层存储体系结构

假设你研究出了下一代的存储技术:“魔法 RAM”。魔法 RAM 的位元是非易失性的；它的访问延迟是 SRAM 的 2 倍，与 DRAM 相同 ；读/写时的能耗和成本与 DRAM 相当；比 DRAM 的密度更高。然而， 魔法 RAM 有一个缺点: 每个位元在执行 2000 次写操作之后会停止运转。

1. 相比 DRAM，魔法 RAM 除了密度高之外，还有什么优势么? 请解释。

   非易失性可以让这种RAM用作ROM从而加速ROM的读取效率。同时其不用定期刷新。

2. 相比 SRAM，魔法 RAM 有什么优势吗? 请解释。

   魔法RAM有更高的密度和更低的能耗。

3. 假设一个系统有 64KB SRAM 的 L1 cache 、12MB SRAM 的 L2 cache 和 4GB DRAM 的主存。

   假设你可以利用这个分层存储结构，经过自由地设计和增加任何结构以克服魔法 RAM 的缺陷(除了修改魔法 RAM 本身) 

   可能将魔法 RAM 加入这个分层存储结构以减小它的缺陷吗? 如果可能, 魔法 RAM 该放到哪里? 根据上面的图来说明，并说明为什么选择放在这个位置。 如果不可能，为什么? 请解释。

   可以将其加入，设置为DRAM同一层次的存储器，对于高读取、低写入的部分内容存取在魔法RAM上，其余存在DRAM上。

4. 请给出一种通过修改这个分层存储结构以减少或克服魔法 RAM 缺陷的方法。请简单清晰地说明你的方法，可以利用图示来说明问题。

   使用DRAM作为魔法RAM的写缓冲，整体层级如图：

   | L1-cache |
   | :------: |
   | L2-cache |
   |   DRAM   |
   | 魔法RAM  |

   L2-cache可以直接访问魔法RAM进行读取操作，但写入时只能写入DRAM，当写入固定下来时，再写入魔法RAM。

## 6. 虚存和 cache

一个 2 路组相联 cache，采用写回策略和 LRU 替换策略，需要 15x2^9 bit 的标签存储来存储包括有效位、脏位以及 LRU 等标签信息。Cache 虚拟索引，物理标签。虚拟地址空间 1MB，页大小是 2 KB， cache 块大小是 8 字节。

1. 该 cache 的数据存储是多少字节？

   一共2^9个组，因此一共2^9 * 2 * 8B = 8KB 

2. 虚拟索引中有多少位来自虚页号？

   虚拟地址共20位，页内偏移11位，所以虚页号9位。

3. 这个存储系统的物理地址空间有多大？

   2路组相联，每组脏位、有效位有2个，LRU有1位，剩余为标签2个，可以知道一个标签5位。

   标签5位，页大小是 2 KB，因此总物理大小64KB。