# 作业五

## 1. cache

| 序列 | 地址                                         | 命中率 |
| ---- | -------------------------------------------- | ------ |
| 1    | 0, 2, 4, 8, 16, 32                           | 0.33   |
| 2    | 0, 512, 1024, 1536, 2048, 1536, 1024, 512, 0 | 0.33   |
| 3    | 0, 64, 128, 256, 512, 256, 128, 64, 0        | 0.33   |
| 4    | 0, 512, 1024, 0, 1536, 0, 2048, 512          | 0.25   |

上面给出了运行在带数据 cache 的处理器上的程序所生成的四种不同的地址序列，同时给出了每种序 列的 cache 命中率。假设 cache 在每个序列开始时是空的，请回答该处理器数据 cache 的下述参数分别是多少：

- 相联度(1, 2 还是 4 路) 

  4路。根据序列3，无论何种情况它们都应映射到统一组中，只有组中有4路时才会达到0.33的命中率。

- 块大小(1, 2, 4, 8, 16 还是 32 字节)

  8字节。根据序列1，只有块大小是8字节时能够达成0.33的命中率。

- cache 总容量(256 还是 512 字节) 

  都可以。

- 替换策略(LRU 还是 FIFO) 

  LRU，根据序列4，使用FIFO时命中率大于0.25。

## 2. 内存的交叉存取

### 2.1 

一台机器有 4 KB 的主存，由 1 个通道、1 个 rank 和 N(N>1)个 bank 构成。系统没有虚拟存储。 

- 数据采用 cache 块交叉存取策略进行交叉存取，即连续的 cache 块对应到连续的 bank 上；
- cache 块大小为 32 字节，bank 的 1 行有 128 字节；
- 采用打开行策略，即行缓冲中的行在被访问后继续保持在行缓冲中，直到有别的行被访问； 
- 行缓冲命中指访问的行存在于行缓冲中，行缓冲缺失指访问的行不在行缓冲中。

1. 某个程序在这台机器上执行，访问以下字节时(数字表示字节的位置，比如 320 表示第 320 个字节) 发生片上 cache 缺失而需要访存：0, 32, 320, 480, 4, 36, 324, 484, 8, 40, 328, 488, 12, 44, 332, 492，若行缓冲命中率为 0，即所有访问的行都不在行缓冲中，请问 bank 数 N 的最小值是多少? 

   对于cache的访问，其访问的cache块编号顺序为：0、1、10、15、0、1、10、15、0、1、10、15、0、1、10、15；

   N=1时，cache块只能映射到同一bank上，bank1行128字节可以存放4个cache块，0、1映射到同一行，访存时会发生行缓冲命中；

   N=2时，0、1号cache块分布在两个不同的bank上，0、10、15在不同行，符合题意。

   因此最小N=2。

2. 如果对于同一个序列，行缓冲命中率是 75%，请问 bank 数 N 的最小值是多少? 

   想要命中率达到75%，必须要0、1、10、15块在首次访问后，后续访问都在行缓冲内。

   从N=1向上推理，可知N=4时，0号cache在bank0、1号cache在bank1、10号cache在bank2、15号cache在bank3，可以符合要求。

   所以最小N=4。

3. 对于同一序列，行缓冲的命中率能达到 100%吗? 请解释原因；如果能达到, 最少需要多少 bank 才能够获得100%的行缓冲命中率? 

   行缓冲命中率不能达到100%，因为首次访问时无论如何行缓冲一定是缺失的；

   如果不考虑初次访问时的行缓冲缺失，那么第2问中4个bank就可以达到100%命中率。

### 2.2 

一个 DRAM 主存储系统由 1 个通道、1 个 rank 和 N 个 bank 构成。Bank 一行 256 字节，一个 cache 块 64 字节。数据采用跨 bank 的行交叉存取方式组织，物理地址的分配方案如下：

|  行  | Bank |  列  | Bytes in Block |
| :--: | :--: | :--: | :------------: |

采用打开行策略，即行缓冲中的行在被访问后继续保持在行缓冲中，直到有别的行被访问。初始时，所有 bank 的第1024行打开。

1.  当有如下的 cache 块访问序列时，如果系统的行缓冲命中率为 33.3% (即 1/3)，请问系统中共有多 少个 bank: 0, 4, 8, 16, 32, 64, 128, 256, 128, 64, 32, 16, 8, 4, 0

   N=128时，第二次访问64、32、16、8、4时会命中，命中率为1/3。

2. 如果行缓冲命中率是 7/15，请问系统中共有多少个 bank? 

   N=512时，第二次访问128, 64, 32, 16, 8, 4, 0时会命中，命中率7/15。

## 3 Bank

一个处理器的分层存储结构由一个小的 SRAM L1-cache 和一个大的 DRAM 主存储器组成，SRAM 和 DRAM 都被划分成 bank。处理器有 24 位物理地址空间，并且不支持虚拟存储(即所有地址都是物理地 址)。某个应用开始在这个处理器上运行，下图显示了在时间尺度上应用对存储系统引用的过程(包括 在 L1-cache 和主存中)。 例如, 应用对存储第一次引用的字节地址是 0xffbc67(假设所有的引用都是对按字节编址的内存地址的 按字节读取)，但是这次引用在 L1-cache 中不命中 (假设 L1-cache 初始时为空)。紧接着，应用访问主 存，这会经历一次行缓冲的不命中(初始时，假设主存的所有 bank 都打开一个永远不会被任何应用访 问的行)。最后，包含字节地址 0xffbc67 的 cache 块从主存取到 cache 中。 随后的内存引用可能会经历 L1-cache 和/或主存的 bank 冲突(当某个特定的 bank 还在提供之前的某个 引用时)。