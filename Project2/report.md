# 高等计算机体系结构实验·Lab2-Lab5

## Lab2 单周期右移器

### 问题解答

1. 1位的选择器需要使用4个门电路；32位选择器在不进行复用的情况下需要32*4=128个门电路。N位选择器需要使用4N个门电路。
2. 使用N位选择器来构建左位移器，与实验中实现的右位移器基本相同。
3. 在不进行合并时，两个位移器需要分别使用一套实现出来的右移器；合并之后大概可以减少一半的门电路。
4. 如果需要同时实现左移和右移，可以更改电路连接方式，让数据可以反向输入门电路，再对输出进行反向，从而达到右移改为左移的目的。三种操作合并之后，门电路单元数量约为原来分开实现的1/3。

### 实现说明

- 对`shamt`的每一位进行分别操作，如果该位值为1，则对应需要右移1、2、4、8、16位。
- 对于算数位移，需要考虑是否复制符号位；逻辑位移则等同于算数位移中的正数位移。

### 测试说明

- 覆盖逻辑位移（正、负数）、算数位移（正、负数）即可保证正确性。

## Lab3 流水线右移器

### 问题解答

1.1 因为流水线的处理器不能在1周期内计算出结果，因此需要提供两个接口，一个用于送入数据，另一个用于读取结果。

1.2 如果在同一`rule`中实现会导致流水段空闲甚至死锁。

1.3 吞吐量为1，流水段充满后每周期可以产生一个结果。

### 实现说明

- 一共分为5个流水段。每段分别进行右移1、2、4、8、16位的操作。
- 段与段之间使用寄存器存储：目前得到的结果、剩余的位移位数、符号位。

### 测试说明

- 同Lab2.

## Lab4 SMIPS处理器1

### 实现说明

- 非流水线	

  - 剔除`doExecute`关于`writeback`的代码

  - 增加寄存器存储用于`writeback`阶段的数据

  - 修改状态机，增加`writeback`状态，并在`doExecute`后指向该状态

  - 增加`doWriteback`的`rule`，包含前面剔除的代码，在状态机指向新增状态时执行

- 流水线增加转发
  - `doExecute`发现需要转发时，向用于转发的寄存器中存入有关跳转的信息
  - 如果发现分支预测错误，则将分支预测错误标记反转（`doFetch`阶段的`fEpoch`和`doExecute`阶段的`eEpoch`），只有标志能够对应的情况下才会运算指令。

## Lab5 SMIPS处理器2

### 实现说明

- 修改流水线为三段
  - 将`doExecute`中解析指令、读取寄存器部分上移到`doFetch`阶段
  - 增加计分板，当解析到指令需要写寄存器时，将对应寄存器计入计分板
  - 修改流水线寄存器存储内容
    - 对于`Fetch->Execute`，增加存储从寄存器中读出的数值；增加存储指令解析结果
    - 增加`Execute->Writeback`寄存器，存储需要写回的寄存器地址和数据
  - 将`doExecute`中写回部分移到`doWriteback`阶段
  - `doFetch`增加数据冲突检测，检测计分板
- 增加转发
  - 增加从`Writeback`到`Fetch`阶段的转发
  - 增加寄存器，存储转发的需要写回的寄存器地址和数据
  - `doFetch`阶段增加数据转发判断，当计分板提示需要等待数据时，读取转发寄存器判断数据是否已经到达

### 问题解答

上述设计并没有完全充盈流水段。

虽然总共3个流水段的情况下，增加了数据转发以后可以基本解决数据冲突问题；

但是仍然存在分支预测错误情况，从而导致流水线清空。

