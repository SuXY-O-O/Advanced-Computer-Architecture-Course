# 作业 3： 流水线 1 

## 1. 流水线

- 非流水线机器

  每个MUL指令：$1+1+5+2=9$周期

  每个ADD指令：$1+1+2+2=6$周期

  一共需要：$9\times3+6\times3=45$周期

- 采用计分板（scoreboarding）的流水线机器，有 5 个加法器、5 个乘法器，没有数据转发逻辑

  取指和译码两个阶段可以提前执行，执行后如果存在数据冲突则需要暂停。

  ```MIPS
  MUL R3 R1, R2	//直接执行，占用一个乘法器，结束时为9周期
  ADD R5 R4, R3	//等待R3，结束时为9-2+6=13周期
  ADD R6 R4, R1	//可以直接执行，占用一个加法器，结束时为9-2+1+6=14周期
  MUL R7 R8, R9	//可以直接执行，占用一个乘法器，结束时为9-2+2+9=18周期
  ADD R4 R3, R7	//等待R7，结束时为18-2+6=22周期
  MUL R10 R5, R6	//可以直接执行，占用一个乘法器，结束时为18-2+1+9=26周期
  ```

  需要26周期

- 采用计分板（scoreboarding）的流水线机器，有 5 个加法器、5 个乘法器，带数据转发逻辑

  MUL数据完成需要$1+1+5=7$周期

  ADD数据完成需要$1+1+2=4$周期

  ```MIPS
  MUL R3 R1, R2	//直接执行，占用一个乘法器，结束时为9周期，可以转发数据时为7周期
  ADD R5 R4, R3	//等待R3，结束时为7-2+6=11周期
  ADD R6 R4, R1	//可以直接执行，占用一个加法器，结束时为7-2+1+6=12周期
  MUL R7 R8, R9	//可以直接执行，占用一个乘法器，结束时为7-2+2+9=16周期，可以转发数据时为14周期
  ADD R4 R3, R7	//等待R7，结束时为14-2+6=18周期
  MUL R10 R5, R6	//可以直接执行，占用一个乘法器，结束时为14-2+1+9=22周期
  ```

  需要22周期

- 采用计分板（scoreboarding）的流水线机器，有 1 个加法器、1 个乘法器，没有数据转发逻辑
  ```MIPS
  MUL R3 R1, R2	//直接执行，占用一个乘法器，结束时为9周期
  ADD R5 R4, R3	//等待R3，结束时为9-2+6=13周期
  ADD R6 R4, R1	//等待加法器，结束时为13-2（写回）-2（提前执行取指和译码）+6=15周期
  MUL R7 R8, R9	//可以直接执行,结束时为13-2-2+1+9=19周期
  ADD R4 R3, R7	//等待R7，结束时为19-2+6=23周期
  MUL R10 R5, R6	//可以直接执行，结束时为19-2+1+9=27周期
  ```

  需要27周期
  
- 采用计分板（scoreboarding）的流水线机器，有 1 个加法器、1 个乘法器，带数据转发逻辑

  ```MIPS
  MUL R3 R1, R2	//直接执行，结束时为9周期，可以转发数据时为7周期
  ADD R5 R4, R3	//等待R3，结束时为7-2+6=11周期，加法器空闲为9周期
  ADD R6 R4, R1	//等待加法器，结束时为9+6-2=13周期
  MUL R7 R8, R9	//可以直接执行，结束时为9-2+1+9=17周期，可以转发数据时为15周期
  ADD R4 R3, R7	//等待R7，结束时为15-2+6=19周期
  MUL R10 R5, R6	//可以直接执行，结束时为15-2+1+9=23周期
  ```

  需要23周期
  
## 2. 延迟槽

一台五阶段流水线的机器，五个流水段分别是：取指、译码、执行、访存和写回。该机器采用延迟槽 技术处理控制相关。无条件分支和有条件分支都在执行阶段获得分支的结果。

- 需要多少个延迟槽才能够确保正确的操作? 

  需要2个延迟槽

- 按照你设计的延迟槽数量，下列汇编指令序列中，哪（些）条指令可以放入延迟槽？请使用合适的延迟槽填充方案重写下边的汇编指令代码。

  - ```
    ADD R5 R4, R3
    OR R3 R1, R2
    SUB R7 R5, R6
    J X
    延迟槽
    LW R10 (R7)
    ADD R6 R1, R2
    X:
    ```

    修改：

    ```
    ADD R5 R4, R3
    J X
    OR R3 R1, R2
    SUB R7 R5, R6
    LW R10 (R7)
    ADD R6 R1, R2
    X:
    ```

  - ```
    ADD R5 R4, R3
    OR R3 R1, R2
    SUB R7 R5, R6
    BEQ R5 R7, X
    延迟槽
    LW R10 (R7)
    ADD R6 R1, R2
    X: 
    ```
    修改：
    ```
    ADD R5 R4, R3
    SUB R7 R5, R6
    BEQ R5 R7, X
    OR R3 R1, R2
    NOP
    LW R10 (R7)
    ADD R6 R1, R2
    X: 
    ```
  
  - ```
    ADD R2 R4, R3
    OR R5 R1, R2
    SUB R7 R5, R6
    BEQ R5 R7, X
    延迟槽
    LW R10 (R7)
    ADD R6 R1, R2
    X: 
    ```
    修改：
    ```
    ADD R2 R4, R3
    OR R5 R1, R2
    SUB R7 R5, R6
    BEQ R5 R7, X
    NOP
    NOP
    LW R10 (R7)
    ADD R6 R1, R2
    X:
    ```

- 你能修改流水线减少延迟槽的数量吗(不使用分支预测的技术)? 请清楚地说明你的方法并解释为什么这样能减少延迟槽。

  增加执行段到取指段的数据转发，可以将执行段得到跳转要求直接影响到取出的指令，从而使得延迟槽减少为1。
