# 作业3

## 1. 分支预测

### （a）当使用 last-time 预测器时三个分支的预测准确率分别是多少？

- 分支1：共执行1000次，其中末次会预测为发生，预测错误，总体准确率99.9%
- 分支2：共发生1000次，每4次中，实际运行状态为：不跳转、跳转、跳转、跳转，实际预测为：跳转、不跳转、跳转、跳转，发生两次错误。总体正确率50%
- 分支3：共发生1000次，每2次中，实际运行状态为：不跳转、跳转；实际预测为：跳转、不跳转。总体正确率0%

### （b）当使用基于 2-bit 饱和计数器的预测器时三个分支的预测准确率分别是多少？

- 分支1：仍然只有最后一次预测错误，正确率99.9%；

- 分支2：

  - | 实际 | 发生     | 不发生   | 不发生   | 不发生   | 发生     | 不发生   | 不发生   | 不发生   | 发生     | 不发生   | 不发生   | 不发生   |
    | ---- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
    | 预测 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 |

  - 每4次错1次，准确率75%

- 分支3：

  - | 实际 | 发生     | 不发生   | 发生     | 不发生   | 发生     | 不发生   |
    | ---- | -------- | -------- | -------- | -------- | -------- | -------- |
    | 预测 | 强不发生 | 弱不发生 | 强不发生 | 弱不发生 | 强不发生 | 弱不发生 |

  - 每两次中错误1次，准确率50%

### （c）当分支 2 和分支 3 的 2-bit 计数器起始状态分别是 (i)‘弱不发生’

- 分支2：

  - | 实际 | 发生     | 不发生 | 不发生   | 不发生   | 发生     | 不发生   | 不发生   | 不发生   | 发生     | 不发生   | 不发生   | 不发生   |
    | ---- | -------- | ------ | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
    | 预测 | 弱不发生 | 弱发生 | 弱不发生 | 强不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 |

  - 前4次错了2次，后面每4次错1次，准确率74.9%

- 分支3：

  - | 实际 | 发生     | 不发生 | 发生     | 不发生 | 发生     | 不发生 |
    | ---- | -------- | ------ | -------- | ------ | -------- | ------ |
    | 预测 | 弱不发生 | 弱发生 | 弱不发生 | 弱发生 | 弱不发生 | 弱发生 |

  - 每次都错误，准确率0%

### （c）当分支 2 和分支 3 的 2-bit 计数器起始状态分别是 (ii)‘弱发生’

- 分支2：

  - | 实际 | 发生   | 不发生 | 不发生 | 不发生   | 发生     | 不发生   | 不发生   | 不发生   | 发生     | 不发生   | 不发生   | 不发生   |
    | ---- | ------ | ------ | ------ | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
    | 预测 | 弱发生 | 强发生 | 弱发生 | 弱不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 | 强不发生 | 弱不发生 | 强不发生 | 强不发生 |

  - 前4次错了2次，后面每4次错1次，准确率74.9%

- 分支3：

  - | 实际 | 发生   | 不发生 | 发生   | 不发生 | 发生   | 不发生 |
    | ---- | ------ | ------ | ------ | ------ | ------ | ------ |
    | 预测 | 弱发生 | 强发生 | 弱发生 | 强发生 | 弱发生 | 强发生 |

  - 每2次错1次，准确率50%

### （d）当使用两层全局历史分支预测器（2bit 全局历史寄存器+每分支一张独立的模式历史表，模式历史表的每个表项是一个 2-bit 饱和计数器）时，三个分支的预测准确率分别是多少？假设全局历史寄存器每一位的初始状态都是‘不发生’，模式历史表中的 2-bit 饱和计数器初始状态都是‘强不发生’，计算预测准确率时，忽略前 500 次循环迭代。

- GHR中以（00）111-100-101-100循环

- 分支1变化：

  - | 全局状态 | 模式变化                                  |
    | -------- | ----------------------------------------- |
    | 00       | 强不发生-弱不发生-弱发生-强发生-强发生-…… |
    | 01       | 强不发生-弱不发生-弱发生-强发生-强发生-…… |
    | 10       | 强不发生-弱不发生-弱发生-强发生-强发生-…… |
    | 11       | 强不发生-弱不发生-弱发生-强发生-强发生-…… |

  - 最终都会变成强发生。后500次中只有最后1次预测错误，准确率99.8%

- 分支2变化：

  - | 全局状态 | 模式变化                                   |
    | -------- | ------------------------------------------ |
    | 00       | 强不发生（不变）                           |
    | 01       | 强不发生-弱不发生-（强不发生-弱不发生）-…… |
    | 10       | 强不发生（不变）                           |
    | 11       | 强不发生-强不发生-（强不发生）-……          |

  - 都预测为不发生，准确率75%

- 分支3变化：

  - | 全局状态 | 模式变化                                                     |
    | -------- | ------------------------------------------------------------ |
    | 00       | 强不发生（不变）                                             |
    | 01       | 强不发生（不变）                                             |
    | 10       | 强不发生-强不发生-弱不发生-强不发生-（强不发生-弱不发生-强不发生）-…… |
    | 11       | 强不发生-弱不发生-弱发生-强发生-（强发生）-……                |

  - 500次以后，每4次预测中，第1、2、4次预测成功，第3次预测失败，总体准确率75%

## 2. 两层分支预测器

1. 假设一个两层全局预测器由全局历史寄存器和所有分支共享的一张模式历史表组成(称为预测器 A)。我们把分支预测器中不同的分支映射到相同位置的情况称为"分支干扰"。预测器 A 的结构中，不同分支会在哪里发生这种干扰?

   由于预测器A中所有分支共享一张模式历史表，所以实际上预测器A无时无刻都存储在着分支干扰。特别的，当两个不同分支读取到的全局历史值相同时，这两个分支就会使用同一张模式历史表，从而出现分支干扰。

2. 另一个两层全局预测器由全局历史寄存器和每个分支一张模式历史表组成 (称为预测器 B"),

   - 什么情况下预测器A的预测准确率低于预测器B? 请解释理由，并举例说明。可以通过代码来说明。

     例如题目1中的代码，分支2和分支3会公用全局状态“11”对应的模式历史表，而分支1与分支2、3会公用所有模式历史表。由于分支1、2、3的各自行为周期都不同：分支1几乎每次发生、分支2每2次发生1次、分支3每4次发生1次，导致他们公用模式历史表时候会相互影响。

   - 预测器A能获得比预测器B更高的预测准确率吗? 请解释理由，并举例说明。可以通过代码来说明。

     有可能。是想存在某两分支，它们的分支发生与否完全随机，那么通过历史信息来预测分支是否发生完全没有意义，因此预测器A与预测器B实际上都可以认为是在纯随机地进行预测，那么A就有可能比B准确。

   - 分支干扰是否总是影响预测器的预测准确率? 请解释理由，并举例说明。可以通过代码来说明。

     不一定。当某两个分支发生的规律完全一致或完全相反时，则分支干扰对于预测器准确率没有干扰。

## 3. 分支预测和推断

1. 这一段代码会重复执行上百次，分支 40%可能性发生，60%可能性不发生，平均而言，P 取什么样的 值会使机器 A 比机器 B 具有更高的指令吞吐量?

   - 对于机器B：

     分支发生时：

     | 指令                | 取指 | 译码                        | 执行              | 写回 |
     | ------------------- | ---- | --------------------------- | ----------------- | ---- |
     | add     r3  r1, r2  | 1    | 2-9                         | 10-14             | 15   |
     | sub     r5 r6, r7   | 2    | 3-10                        | 11-15             | 16   |
     | cmp     r3, r5      | 3    | 4-11                        | 等待r3、r5，16-20 | 21   |
     | addi.ne  r10 r1, 5  | 4    | 5-11，阻塞，16              | 等待cmp，舍弃     | 舍弃 |
     | add.ne  r12 r7, r2  | 5    | 6-11，阻塞，16，阻塞，舍弃  | 舍弃              | 舍弃 |
     | add.ne  r14 r11, r9 | 6    | 7-11，阻塞，16，阻塞，舍弃  | 舍弃              | 舍弃 |
     | addi    r15 r2, 10  | 7    | 8-11，阻塞，16，阻塞，21-23 | 24-28             | 29   |

     分支不发生时：

     | 指令                | 取指 | 译码                        | 执行              | 写回 |
     | ------------------- | ---- | --------------------------- | ----------------- | ---- |
     | add     r3  r1, r2  | 1    | 2-9                         | 10-14             | 15   |
     | sub     r5 r6, r7   | 2    | 3-10                        | 11-15             | 16   |
     | cmp     r3, r5      | 3    | 4-11                        | 等待r3、r5，16-20 | 21   |
     | addi.ne  r10 r1, 5  | 4    | 5-11，阻塞，16              | 等待cmp，21-25    | 26   |
     | add.ne  r12 r7, r2  | 5    | 6-11，阻塞，16，阻塞，21    | 22-26             | 27   |
     | add.ne  r14 r11, r9 | 6    | 7-11，阻塞，16，阻塞，21-22 | 23-27             | 28   |
     | addi    r15 r2, 10  | 7    | 8-11，阻塞，16，阻塞，21-23 | 24-28             | 29   |

     所以，机器B总是需要29个周期来完成上述代码的执行。

   - 对于机器A：

     分支发生、预测正确：

     | 指令                  | 取指 | 译码           | 执行              | 写回 |
     | --------------------- | ---- | -------------- | ----------------- | ---- |
     | add     r3  r1, r2    | 1    | 2-9            | 10-14             | 15   |
     | sub     r5 r6, r7     | 2    | 3-10           | 11-15             | 16   |
     | beq   r3, r5, X       | 3    | 4-11           | 等待r3、r5，16-20 | 21   |
     | X: addi    r15 r2, 10 | 4    | 5-11，阻塞，16 | 17-21             | 22   |

     分支发生、预测错误：

     | 指令                  | 取指 | 译码  | 执行              | 写回 |
     | --------------------- | ---- | ----- | ----------------- | ---- |
     | add     r3  r1, r2    | 1    | 2-9   | 10-14             | 15   |
     | sub     r5 r6, r7     | 2    | 3-10  | 11-15             | 16   |
     | beq   r3, r5, X       | 3    | 4-11  | 等待r3、r5，16-20 | 21   |
     | X: addi    r15 r2, 10 | 21   | 22-29 | 30-34             | 35   |

     分支不发生：预测正确

     | 指令                  | 取指 | 译码              | 执行              | 写回 |
     | --------------------- | ---- | ----------------- | ----------------- | ---- |
     | add     r3  r1, r2    | 1    | 2-9               | 10-14             | 15   |
     | sub     r5 r6, r7     | 2    | 3-10              | 11-15             | 16   |
     | beq     r3, r5,X      | 3    | 4-11              | 等待r3、r5，16-20 | 21   |
     | addi  r10 r1, 5       | 4    | 5-11，阻塞，16    | 17-21             | 22   |
     | add  r12 r7, r2       | 5    | 6-11，阻塞，16-17 | 18-22             | 23   |
     | add  r14 r11, r9      | 6    | 7-11，阻塞，16-18 | 19-23             | 24   |
     | X: addi    r15 r2, 10 | 7    | 8-11，阻塞，16-19 | 20-24             | 25   |

     分支不发生、预测错误

     | 指令                  | 取指         | 译码  | 执行              | 写回 |
     | --------------------- | ------------ | ----- | ----------------- | ---- |
     | add     r3  r1, r2    | 1            | 2-9   | 10-14             | 15   |
     | sub     r5 r6, r7     | 2            | 3-10  | 11-15             | 16   |
     | beq     r3, r5,X      | 3            | 4-11  | 等待r3、r5，16-20 | 21   |
     | addi  r10 r1, r5      | 预测错误，21 | 22-29 | 30-34             | 35   |
     | add  r12 r7, r2       | 22           | 23-30 | 31-35             | 36   |
     | add  r14 r11, r9      | 23           | 24-31 | 32-36             | 37   |
     | X: addi    r15 r2, 10 | 24           | 25-32 | 33-37             | 38   |

     总体来说，机器A执行代码需要：$40\% \times (P \times 22 + (1 - P)\times 35) + 60\% \times (P \times25 + (1-P)\times38)=36.8-13P $

   - 要让A吞吐量大于B，则$36.8-13P < 29$，即$P > 0.6$

2. 考察在机器 A 上执行的另一段代码，这一段代码会重复执行上百次，分支 40%可能性发生，60%可能性不发生，平均而言，P取什么样的值会使机器A比机器B具有更高的指令吞吐量?

   - 对于机器B：
   
     分支发生时：
   
     | 指令                | 取指 | 译码                        | 执行              | 写回 |
     | ------------------- | ---- | --------------------------- | ----------------- | ---- |
     | add     r3  r1, r2  | 1    | 2-9                         | 10-14             | 15   |
     | sub     r5 r6, r7   | 2    | 3-10                        | 11-15             | 16   |
     | cmp     r3, r5      | 3    | 4-11                        | 等待r3、r5，16-20 | 21   |
     | addi.ne  r10 r1, 5  | 4    | 5-11，阻塞，16              | 等待cmp，舍弃     | 舍弃 |
     | add.ne  r12 r10, r2 | 5    | 6-11，阻塞，16，阻塞，舍弃  | 舍弃              | 舍弃 |
     | add.ne  r14 r12, r9 | 6    | 7-11，阻塞，16，阻塞，舍弃  | 舍弃              | 舍弃 |
     | addi    r15 r14, 10 | 7    | 8-11，阻塞，16，阻塞，21-23 | 24-28             | 29   |
   
     分支不发生时：
   
     | 指令                | 取指 | 译码                                         | 执行              | 写回 |
     | ------------------- | ---- | -------------------------------------------- | ----------------- | ---- |
     | add     r3  r1, r2  | 1    | 2-9                                          | 10-14             | 15   |
     | sub     r5 r6, r7   | 2    | 3-10                                         | 11-15             | 16   |
     | cmp     r3, r5      | 3    | 4-11                                         | 等待r3、r5，16-20 | 21   |
     | addi.ne  r10 r1, 5  | 4    | 5-11，阻塞，16                               | 等待cmp，21-25    | 26   |
     | add.ne  r12 r10, r2 | 5    | 6-11，阻塞，16，阻塞，21                     | 等待r10，26-30    | 31   |
     | add.ne  r14 r12, r9 | 6    | 7-11，阻塞，16，阻塞，21，阻塞，26           | 等待r12，31-35    | 36   |
     | addi    r15 r14, 10 | 7    | 8-11，阻塞，16，阻塞，21，阻塞，26，阻塞，31 | 等待r14，36-40    | 41   |
   
     总体来说，机器B平均使用周期：$29 \times 40\% + 41 \times 60\%=36.2$
   
   - 对于机器A：
   
     分支发生、预测正确：
   
     | 指令                   | 取指 | 译码           | 执行              | 写回 |
     | ---------------------- | ---- | -------------- | ----------------- | ---- |
     | add     r3  r1, r2     | 1    | 2-9            | 10-14             | 15   |
     | sub     r5 r6, r7      | 2    | 3-10           | 11-15             | 16   |
     | beq   r3, r5, X        | 3    | 4-11           | 等待r3、r5，16-20 | 21   |
     | X: addi    r15 r14, 10 | 4    | 5-11，阻塞，16 | 17-21             | 22   |
   
     分支发生、预测错误：
   
     | 指令                   | 取指         | 译码  | 执行              | 写回 |
     | ---------------------- | ------------ | ----- | ----------------- | ---- |
     | add     r3  r1, r2     | 1            | 2-9   | 10-14             | 15   |
     | sub     r5 r6, r7      | 2            | 3-10  | 11-15             | 16   |
     | beq   r3, r5, X        | 3            | 4-11  | 等待r3、r5，16-20 | 21   |
     | X: addi    r15 r14, 10 | 预测错误，21 | 22-29 | 30-34             | 35   |
   
     分支不发生：预测正确
   
     | 指令                   | 取指 | 译码                                  | 执行              | 写回 |
     | ---------------------- | ---- | ------------------------------------- | ----------------- | ---- |
     | add     r3  r1, r2     | 1    | 2-9                                   | 10-14             | 15   |
     | sub     r5 r6, r7      | 2    | 3-10                                  | 11-15             | 16   |
     | beq     r3, r5,X       | 3    | 4-11                                  | 等待r3、r5，16-20 | 21   |
     | addi  r10 r1, 5        | 4    | 5-11，阻塞，16                        | 17-21             | 22   |
     | add  r12 r10, r2       | 5    | 6-11，阻塞，16-17                     | 等待r10，22-26    | 27   |
     | add  r14 r12, r9       | 6    | 7-11，阻塞，16-17，阻塞，22           | 等待r12，27-31    | 32   |
     | X: addi    r15 r14, 10 | 7    | 8-11，阻塞，16-17，阻塞，22，阻塞，27 | 等待r14，32-36    | 37   |
   
     分支不发生、预测错误
   
     | 指令                   | 取指         | 译码                      | 执行              | 写回 |
     | ---------------------- | ------------ | ------------------------- | ----------------- | ---- |
     | add     r3  r1, r2     | 1            | 2-9                       | 10-14             | 15   |
     | sub     r5 r6, r7      | 2            | 3-10                      | 11-15             | 16   |
     | beq     r3, r5,X       | 3            | 4-11                      | 等待r3、r5，16-20 | 21   |
     | addi  r10 r1, r5       | 预测错误，21 | 22-29                     | 30-34             | 35   |
     | add  r12 r10, r2       | 22           | 23-30                     | 等待r10，35-39    | 40   |
     | add  r14 r12, r9       | 23           | 24-30，阻塞，35           | 等待r12，40-44    | 45   |
     | X: addi    r15 r14, 10 | 24           | 25-30，阻塞，35，阻塞，40 | 等待r14，45-49    | 50   |
   
     总体来说，机器A执行代码需要：$40\% \times (P \times 22 + (1 - P)\times 35) + 60\% \times (P \times37 + (1-P)\times50)=44-13P $
   
   - 要让A吞吐量大于B，则$44-13P < 36.2$，即$P > 0.6$
